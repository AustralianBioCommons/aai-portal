@if (alert()) {
  <app-alert
    [type]="alert()!.type"
    [message]="alert()!.message"
    [dismissible]="true"
    (dismissed)="alert.set(null)"
  ></app-alert>
}

<!-- Revoke Modal -->
@if (showRevokeModal()) {
  <app-modal
    [title]="'Do you want to revoke ' + selectedUserForRevoke()!.email + '?'"
    type="revoke"
    [textareaControl]="revokeReasonControl"
    [textareaLabel]="'Revocation reason'"
    primaryButtonText="Yes"
    secondaryButtonText="No"
    (primaryOutput)="confirmRevokePlatformAccess()"
    (secondaryOutput)="closeRevokeModal()"
  />
}

<div
  class="relative flex flex-1 grow flex-col gap-12 p-6 md:p-12 lg:px-24 xl:px-48"
>
  <div
    class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
  >
    <!-- Search bar -->
    <div class="w-full md:w-2/3">
      <label
        for="search-input"
        class="mb-1 block text-sm font-medium text-gray-900"
      >
        Search
      </label>
      <div
        class="flex h-12 w-full flex-1 items-center justify-between rounded-md border bg-white py-2 pl-4 pr-2 font-light focus-within:ring-2 focus-within:ring-sky-100"
      >
        <input
          id="search-input"
          class="flex-1 focus:outline-none"
          type="text"
          placeholder="By name or email address"
          [(ngModel)]="searchTerm"
          (input)="onSearchInput()"
          (keydown.enter)="onSearchSubmit()"
        />
        <button
          type="button"
          class="rounded-full p-2 transition-all hover:bg-gray-200"
          (click)="onSearchSubmit()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="size-4 text-biocommons-primary"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"
            />
          </svg>
        </button>
      </div>
    </div>

    <!-- Filter dropdown -->
    <div class="w-full md:w-1/3">
      <label
        for="filter-select"
        class="mb-1 block text-sm font-medium text-gray-900"
      >
        Filter by user group
      </label>
      <select
        id="filter-select"
        class="h-12 w-full rounded-md border-r-8 border-transparent bg-white px-4 py-3 font-light outline outline-1 outline-gray-200 focus-within:ring-2 focus-within:ring-sky-100 hover:cursor-pointer"
        [(ngModel)]="selectedFilter"
        (change)="onFilterChange()"
        [disabled]="loading()"
      >
        <option value="">All</option>
        @for (option of filterOptions(); track option.id) {
          <option [value]="option.id">{{ option.name }}</option>
        }
      </select>
    </div>
  </div>

  <div class="flex flex-1 flex-col">
    <div
      class="sticky z-20 -mx-6 bg-gray-50 px-6 pt-2 md:-mx-12 md:px-12 lg:-mx-24 lg:px-24 xl:-mx-48 xl:px-48"
      style="position: -webkit-sticky; top: 160px"
    >
      <div class="border-b border-gray-200 pb-3">
        <div class="text-3xl font-semibold text-gray-900">{{ title() }}</div>

        <!-- List header -->
        <div
          class="mt-4 flex items-center px-4 text-sm font-medium text-gray-900"
        >
          <div
            class="flex-1"
            [ngClass]="adminType() !== 'bundle' ? 'w-5/12' : 'w-8/12'"
          >
            Total:
            <span class="font-light text-gray-500"
              >{{ totalUsers() }} users</span
            >
          </div>
          <div class="w-3/12">
            {{
              adminType() !== "bundle"
                ? "Bundles"
                : adminGroups()[0].short_name + " Bundle Access"
            }}
          </div>
          @if (adminType() !== "bundle") {
            <div class="w-3/12">
              {{
                adminType() === "biocommons"
                  ? "Services"
                  : adminType() === "platform"
                    ? adminPlatforms()[0].name + " Access"
                    : ""
              }}
            </div>
          }
          <div class="w-1/12"></div>
        </div>
      </div>
    </div>
    @if (loading() && users().length === 0) {
      <div class="flex w-full flex-1 items-center justify-center">
        <app-loading-spinner />
      </div>
    } @else {
      <div class="flex flex-1 flex-col gap-4">
        @if (users().length === 0) {
          <div class="flex flex-1 items-center justify-center text-gray-900">
            No users found
          </div>
        } @else {
          <!-- List items -->
          @for (user of users(); track user.id) {
            <div
              class="flex items-center rounded-md bg-white p-4 font-normal shadow"
            >
              <div
                class="flex-1 truncate"
                [ngClass]="adminType() !== 'bundle' ? 'w-5/12' : 'w-8/12'"
              >
                {{ user.email }}
              </div>
              <div class="flex w-3/12 flex-wrap gap-2">
                @if (user.group_memberships.length) {
                  @if (adminType() !== "bundle") {
                    @for (group of user.group_memberships; track group.id) {
                      <span
                        class="rounded-md border px-2 py-0.5 text-sm font-medium"
                        [ngClass]="{
                          'border-green-600 bg-green-50 text-green-700':
                            group.approval_status === 'approved',
                          'border-yellow-600 bg-yellow-50 text-yellow-800':
                            group.approval_status === 'pending',
                          'border-red-600 bg-red-50 text-red-700':
                            group.approval_status === 'revoked' ||
                            group.approval_status === 'rejected',
                        }"
                      >
                        {{ group.group_short_name }}
                      </span>
                    }
                  } @else {
                    <!-- Show approval status only for bundle admins -->
                    @for (group of user.group_memberships; track group.id) {
                      @if (
                        adminType() === "bundle" &&
                        canManageGroup(group.group_id)
                      ) {
                        <div
                          class="flex items-center gap-2 text-sm font-medium"
                          [ngClass]="{
                            'text-green-500':
                              group.approval_status === 'approved',
                            'text-yellow-500':
                              group.approval_status === 'pending',
                            'text-red-500':
                              group.approval_status === 'revoked' ||
                              group.approval_status === 'rejected',
                          }"
                        >
                          <span class="truncate">
                            {{ group.approval_status | titlecase }}
                          </span>
                          @if (
                            group.approval_status === "revoked" ||
                            group.approval_status === "rejected"
                          ) {
                            <app-tooltip
                              [message]="
                                formatReason(
                                  group.rejection_reason ||
                                    group.revocation_reason,
                                  group.updated_at,
                                  group.updated_by
                                ) ||
                                (group.approval_status === 'rejected'
                                  ? 'Rejected'
                                  : 'Revoked')
                              "
                            />
                          }
                        </div>
                      }
                    }
                  }
                } @else {
                  None
                }
              </div>
              @if (adminType() !== "bundle") {
                <div class="w-3/12">
                  @if (adminType() === "biocommons") {
                    <!-- Show all platforms with names for multi-platform (biocommons) admins -->
                    @for (
                      platform of user.platform_memberships;
                      track platform.id
                    ) {
                      <div
                        class="flex items-center gap-2 text-sm font-medium"
                        [ngClass]="{
                          'text-green-500':
                            platform.approval_status === 'approved',
                          'text-yellow-500':
                            platform.approval_status === 'pending',
                          'text-red-500':
                            platform.approval_status === 'revoked',
                        }"
                      >
                        <span class="truncate">
                          {{ platform.platform_name }}
                        </span>
                        @if (platform.approval_status === "revoked") {
                          <app-tooltip
                            [message]="
                              formatReason(
                                platform.revocation_reason,
                                platform.updated_at,
                                platform.updated_by
                              ) || 'Revoked'
                            "
                          />
                        }
                      </div>
                    }
                  } @else {
                    <!-- Show approval status only for single-platform admins -->
                    @for (
                      platform of user.platform_memberships;
                      track platform.id
                    ) {
                      @if (
                        adminType() === "platform" &&
                        platform.platform_id === adminPlatforms()[0].id
                      ) {
                        <div
                          class="flex items-center gap-2 text-sm font-medium"
                          [ngClass]="{
                            'text-green-500':
                              platform.approval_status === 'approved',
                            'text-yellow-500':
                              platform.approval_status === 'pending',
                            'text-red-500':
                              platform.approval_status === 'revoked',
                          }"
                        >
                          <span class="truncate">
                            {{ platform.approval_status | titlecase }}
                          </span>
                          @if (platform.approval_status === "revoked") {
                            <app-tooltip
                              [message]="
                                formatReason(
                                  platform.revocation_reason,
                                  platform.updated_at,
                                  platform.updated_by
                                ) || 'Revoked'
                              "
                            />
                          }
                        </div>
                      }
                    }
                  }
                </div>
              }
              <div class="relative flex w-1/12 justify-end">
                <!-- Ellipsis menu -->
                <button
                  type="button"
                  class="user-menu-button rounded-full p-1 transition-all hover:bg-gray-200"
                  (click)="toggleUserMenu(user.id)"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-5"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"
                    />
                  </svg>
                </button>
                @if (isMenuOpen(user.id)) {
                  <!-- User menu -->
                  <div
                    class="user-menu-dropdown absolute right-0 top-full z-10 mt-1 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
                    role="menu"
                    aria-orientation="vertical"
                    tabindex="-1"
                  >
                    <div class="py-1">
                      <button
                        type="button"
                        (click)="navigateToUserDetails(user.id)"
                        class="flex w-full items-center justify-start gap-2 px-4 py-2 text-sm text-gray-700 transition-all hover:bg-gray-100 hover:text-gray-900"
                        role="menuitem"
                        tabindex="-1"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          class="size-5"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                          />
                        </svg>
                        View User Details
                      </button>
                      @for (
                        platform of user.platform_memberships;
                        track platform.id
                      ) {
                        <!-- Show revoke button: for multi-platform admins only when user has 1 platform, for single-platform admins show if they manage that platform -->
                        @if (
                          platform.approval_status === "approved" &&
                          ((adminType() === "biocommons" &&
                            user.platform_memberships.length === 1) ||
                            (adminType() === "platform" &&
                              platform.platform_id === adminPlatforms()[0].id))
                        ) {
                          <button
                            type="button"
                            (click)="
                              openRevokeModal(
                                user.id,
                                user.email,
                                platform.platform_id
                              )
                            "
                            class="flex w-full items-center justify-start gap-2 px-4 py-2 text-sm text-gray-700 transition-all hover:bg-gray-100 hover:text-gray-900"
                            role="menuitem"
                            tabindex="-1"
                          >
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              fill="none"
                              viewBox="0 0 24 24"
                              stroke-width="1.5"
                              stroke="currentColor"
                              class="size-5"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                              />
                            </svg>
                            Revoke
                          </button>
                        }
                      }
                      @if (!user.email_verified) {
                        <button
                          type="button"
                          (click)="resendVerificationEmail(user.id)"
                          class="flex w-full items-center justify-start gap-2 px-4 py-2 text-sm text-gray-700 transition-all hover:bg-gray-100 hover:text-gray-900"
                          role="menuitem"
                          tabindex="-1"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke-width="1.5"
                            stroke="currentColor"
                            class="size-5"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07 1.916V6.75"
                            />
                          </svg>
                          Resend Verification Email
                        </button>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }
          @if (loadingMore()) {
            <div
              class="flex items-center justify-center py-4 text-sm text-gray-600"
            >
              <app-loading-spinner />
            </div>
          }
        }
      </div>
    }
  </div>
</div>
